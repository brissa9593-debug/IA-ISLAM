<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IA ISLAM - Assistant Ã‰ducatif</title>
<style>
/* Ajoute ici tout ton CSS du prÃ©cÃ©dent HTML, inchangÃ© */
</style>
</head>
<body>
<header class="header">
    <div class="header-content">
        <div class="header-left">
            <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/6970b76c579f0b3ac47f48b8/ae70ac83f_imageislamiqueia.png" alt="IA Islam" class="logo">
            <div class="header-text">
                <h1>IA ISLAM</h1>
                <p>Islam Sunnite</p>
            </div>
        </div>
        <button class="new-btn" onclick="resetConversation()">ðŸ”„ Nouveau</button>
    </div>
</header>

<div class="container">
    <div class="messages" id="messages">
        <div class="school-selector" id="schoolSelector">
            <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/6970b76c579f0b3ac47f48b8/ae70ac83f_imageislamiqueia.png" alt="IA Islam">
            <h2>As-salamu alaykum</h2>
            <p>Choisissez votre Ã©cole juridique pour des rÃ©ponses adaptÃ©es</p>
            <div class="school-grid">
                <button class="school-btn" onclick="selectSchool('Malikite')">ðŸ•Œ Malikite</button>
                <button class="school-btn" onclick="selectSchool('Hanafite')">ðŸ•Œ Hanafite</button>
                <button class="school-btn" onclick="selectSchool('Shafi\'ite')">ðŸ•Œ Shafi'ite</button>
                <button class="school-btn" onclick="selectSchool('Hanbalite')">ðŸ•Œ Hanbalite</button>
                <button class="school-btn" onclick="selectSchool('Toutes les Ã©coles')" style="grid-column: 1 / -1;">ðŸ“š Toutes les Ã©coles</button>
            </div>
        </div>
    </div>
</div>

<div class="input-area" id="inputArea" style="display:none;">
    <div class="input-container">
        <div class="school-info" id="schoolInfo"></div>
        <form class="input-box" id="chatForm">
            <textarea id="userInput" placeholder="Posez votre question sur l'islam..." rows="1"></textarea>
            <button type="submit" class="send-btn" id="sendBtn">â–¶</button>
        </form>
    </div>
</div>

<script>
const FUNCTION_URL = '/.netlify/functions/chat'; // fonction Netlify
let selectedSchool = null;
let isLoading = false;

const messagesContainer = document.getElementById('messages');
const schoolSelector = document.getElementById('schoolSelector');
const inputArea = document.getElementById('inputArea');
const schoolInfo = document.getElementById('schoolInfo');
const chatForm = document.getElementById('chatForm');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');

userInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight,200)+'px';
});

userInput.addEventListener('keydown', function(e){
    if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
    }
});

async function selectSchool(school){
    selectedSchool = school;
    schoolSelector.style.display = 'none';
    inputArea.style.display = 'block';
    schoolInfo.textContent = `Ã‰cole sÃ©lectionnÃ©e : ${school}`;
    
    addLoading();
    await sendMessage(`[Ã‰cole sÃ©lectionnÃ©e: ${school}] Salamu alaykum, je commence une conversation.`);
}

async function sendMessage(content){
    if(!selectedSchool) return;
    isLoading = true;
    sendBtn.disabled = true;
    userInput.disabled = true;

    try{
        const response = await fetch(FUNCTION_URL,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({content})
        });
        if(!response.ok) throw new Error('Erreur serveur');

        const data = await response.json();
        removeLoading();
        addMessage(data.response,false);

    }catch(e){
        console.error(e);
        removeLoading();
        addMessage('Erreur: Impossible de contacter le serveur',false);
    }finally{
        isLoading=false;
        sendBtn.disabled=false;
        userInput.disabled=false;
        userInput.focus();
    }
}

function addMessage(content,isUser){
    const messageDiv=document.createElement('div');
    messageDiv.className='message'+(isUser?' user':'');
    if(!isUser){
        messageDiv.innerHTML=`
        <div class="avatar ai"><img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/6970b76c579f0b3ac47f48b8/ae70ac83f_imageislamiqueia.png" alt="IA"></div>
        <div class="bubble ai">${content}</div>`;
    } else {
        messageDiv.innerHTML=`<div class="bubble user">${content}</div><div class="avatar user">Vous</div>`;
    }
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop=messagesContainer.scrollHeight;
}

function addLoading(){
    const loadingDiv=document.createElement('div');
    loadingDiv.className='message';
    loadingDiv.id='loading';
    loadingDiv.innerHTML=`<div class="avatar ai"><img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/6970b76c579f0b3ac47f48b8/ae70ac83f_imageislamiqueia.png" alt="IA"></div>
    <div class="bubble ai">Recherche dans les sources...</div>`;
    messagesContainer.appendChild(loadingDiv);
    messagesContainer.scrollTop=messagesContainer.scrollHeight;
}

function removeLoading(){
    const loading=document.getElementById('loading');
    if(loading) loading.remove();
}

function resetConversation(){
    messagesContainer.innerHTML=`
    <div class="school-selector" id="schoolSelector">
        <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/6970b76c579f0b3ac47f48b8/ae70ac83f_imageislamiqueia.png" alt="IA Islam">
        <h2>As-salamu alaykum</h2>
        <p>Choisissez votre Ã©cole juridique pour des rÃ©ponses adaptÃ©es</p>
        <div class="school-grid">
            <button class="school-btn" onclick="selectSchool('Malikite')">ðŸ•Œ Malikite</button>
            <button class="school-btn" onclick="selectSchool('Hanafite')">ðŸ•Œ Hanafite</button>
            <button class="school-btn" onclick="selectSchool('Shafi\'ite')">ðŸ•Œ Shafi'ite</button>
            <button class="school-btn" onclick="selectSchool('Hanbalite')">ðŸ•Œ Hanbalite</button>
            <button class="school-btn" onclick="selectSchool('Toutes les Ã©coles')" style="grid-column:1/-1;">ðŸ“š Toutes les Ã©coles</button>
        </div>
    </div>`;
    inputArea.style.display='none';
    selectedSchool=null;
    isLoading=false;
}

chatForm.addEventListener('submit',async function(e){
    e.preventDefault();
    const question=userInput.value.trim();
    if(!question || isLoading) return;
    addMessage(question,true);
    userInput.value='';
    userInput.style.height='auto';
    addLoading();
    await sendMessage(`[Ã‰cole sÃ©lectionnÃ©e: ${selectedSchool}]\n\n${question}`);
});
</script>
</body>
</html>
